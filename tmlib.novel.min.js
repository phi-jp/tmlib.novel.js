tm.asset.Loader.register("ks",function(a){var b=tm.novel.Script(a);return b}),tm.asset.Loader.register("novel",function(a){var b=tm.novel.Script(a);return b}),tm.define("tm.novel.Script",{superClass:"tm.event.EventDispatcher",loaded:!1,init:function(a){this.superInit(),this.tasks=[],this.tagTable=[],this.macros={},a&&this.load(a)},load:function(a){this.loaded=!1,this.path=a,tm.util.Ajax.load({url:a,dataType:"text",success:function(a){this.extend(a,function(a){this.parse(a),this.loaded=!0,this.fire(tm.event.Event("load"))}.bind(this))}.bind(this)})},reload:function(){this.load(this.path)},extend:function(a,b){var c=a.match(/[@\[]import path=(.*)/gm);if(!c||c.length<=0)return void(b&&b(a));var d=tm.util.Flow(c.length,function(){b&&b(a)});c.each(function(b){var c=b.replace(/[@\[\]]/g,""),e=c.match(/path=(.*)/)[1],f=tm.util.File(e);f.onload=function(){a=a.replace(b,this.data),d.pass()}})},parse:function(a){var b=this,c=this.tasks,d=a.split("\n");return d.each(function(a){a=a.trim();var d=a[0];if("*"==d){var e=a.trim(),f=c.length;b.tagTable[e]=f}else if(";"==d||"/"==a[0]&&"/"==a[1]);else if("@"==d)c.push(b._makeTag(a.substr(1)));else{for(var g=!1,h="",i="",j=0;j<a.length;++j){var k=a[j];1==g?"]"==k?(c.push(b._makeTag(h)),h="",g=!1):h+=k:0==g&&"["==k?(""!=i&&(c.push({type:"text",value:i.trim()}),i=""),g=!0):i+=k}""!=i&&(c.push({type:"text",value:i.trim()}),i="")}}),this},_makeTag:function(a){var b=a.split(" "),c=b.shift(),d={};b.each(function(a){var b=a.split("="),c=b[0],e=a.replace(c+"=","");return e.match(/^[+-]?[0-9]*[\.]?[0-9]+$/)?e=Number(e):"true"===e?e=!0:"false"===e&&(e=!1),d[c]=e});var e={type:"tag",func:c,params:d};return"macro"==c&&(this.macros[d.name]=e),e}}),tm.define("tm.novel.Layer",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.images={}},addImage:function(a,b){this.images[a]=b,this.addChild(b)},getImage:function(a){return this.images[a]},removeImage:function(a){this.images[a].remove(),this.images[a]=null}});var BASIC_PROPS=["x","y","width","height","rotation","scaleX","scaleY","originX","originY","alpha"];tm.define("tm.novel.Element",{superClass:"tm.display.CanvasElement",elementMap:null,init:function(a){this.superInit(),this.script="string"==typeof a?tm.asset.Manager.get(a):a,this.layers={base:tm.novel.Layer().addChildTo(this),0:tm.novel.Layer().addChildTo(this),1:tm.novel.Layer().addChildTo(this),2:tm.novel.Layer().addChildTo(this),message0:tm.novel.Layer().addChildTo(this),message1:tm.novel.Layer().addChildTo(this)},this.taskIndex=0,this.lockFlag=!1,this.chSpeed=1,this.variables={},this.localVariablesStack=[],this.taskStack=[],this.labelArea=tm.ui.LabelArea({text:"",width:430,height:200}).addChildTo(this.layers.message0),this.labelArea.text="",this.labelArea.origin.set(0,0),this.labelArea.x=20,this.labelArea.y=330,this.labelArea.fontSize=16,this.elementMap={},this.basePath="",this.set(0),this.setInteractive(!0),this.setBoundingType("all"),console.log(this.script)},lock:function(){return this.lockFlag=!0,this},unlock:function(){return this.lockFlag=!1,this},jump:function(a){var b="string"==typeof a?this.script.tagTable[a]:a;return this.set(b),this},call:function(a){return this.localVariablesStack.push(this.activeTask.params),this.taskStack.push(this.taskIndex),this.jump(a),this},"return":function(){this.localVariablesStack.pop();var a=this.taskStack.pop()+1;this.set(a)},set:function(a){if(this.taskIndex=a,this.activeTask=this.script.tasks[this.taskIndex],this.seek=0,!this.activeTask){var b=tm.event.Event("taskfinish");this.fire(b),this.flare("finish")}},next:function(){this.set(this.taskIndex+1)},finish:function(){this.set(this.script.tasks.length)},format:function(a){if("string"!=typeof a)return a;var b={}.$extend(this.variables,this.localVariablesStack.last);return a=a.format(b),a.match(/^[+-]?[0-9]*[\.]?[0-9]+$/)?a=Number(a):"true"===a?a=!0:"false"===a&&(a=!1),/^[\[\(\{)]/.test(a)&&(a=JSON.parse(a)),a},macro:function(a){var b=this.script.macros[a],c=this.script.tasks.indexOf(b);this.call(c).next()},setVariable:function(a,b){return this.variables[a]=b,this},getVariable:function(a){return this.variables[a]},addNovelElement:function(a,b,c){void 0===c&&(c=1);var d=this.layers[c];return d.addChild(b),this.elementMap[a]=b,this},getNovelElement:function(a){var b=this.elementMap[a];return b},removeNovelElement:function(a){var b=this.elementMap[a];return b.remove(),this},updateTask:function(a){if(1!=this.lockFlag){var b=this.activeTask;if(b)if("text"==b.type){if(a.frame%this.chSpeed==0){0==this.seek&&(b.value=this.format(b.value));var c=b.value[this.seek++];if(void 0!==c){if(this.labelArea.text+=c,a.pointing.getPointingStart()){for(var d=this.seek,e=b.value.length;e>d;++d){var c=b.value[d];this.labelArea.text+=c}this.next()}}else this.next();var f=tm.event.Event("textupdate");this.fire(f)}}else if("tag"==b.type){var g=tm.novel.Tag.get(b.func),h={};if(g){for(var i in b.params){var j=b.params[i];h[i]=this.format(j)}g.call(this,a,h),this.flare("taskrun",{task:b})}else this.script.macros[b.func]?this.macro(b.func):console.assert(g,"don't define `{0}`!".format(b.func));this.updateTask(a)}else alert()}},update:function(a){this.updateTask(a)}}),function(){tm.novel.Tag={map:{},get:function(a){return this.map[a]},set:function(a,b){if(1==arguments.length){var c=arguments[0];for(var a in c)this.map[a]=c[a]}else this.map[a]=b;return this}},tm.novel.Tag.set({log:function(a,b){var c=b.message||b.msg;console.log(c),this.next()},alert:function(a,b){var c=b.message||b.msg;alert(c),this.next()},debug:function(a,b){var c=b.message||b.msg;console.debug(c),this.next()},trace:function(app,params){console.log(eval(params.exp)),this.next()},"var":function(a,b){var c=b.value;this.variables[b.key]=c,this.next()},"if":function(app,params){var exp=params.exp,rst=eval(exp);if(1==rst){for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func){this.endifIndex=i;break}}this.next()}else for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func||"elseif"==task.func||"else"==task.func){this.set(i);break}}},elseif:function(app,params){if(this.endifIndex)return void this.set(this.endifIndex);var exp=params.exp.format(this.variables),rst=eval(exp);if(1==rst){for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func){this.endifIndex=i;break}}this.next()}else for(var tasks=this.script.tasks,i=this.taskIndex+1,len=tasks.length;len>i;++i){var task=tasks[i];if("endif"==task.func||"elseif"==task.func||"else"==task.func){this.set(i);break}}},"else":function(){return this.endifIndex?void this.set(this.endifIndex):void this.next()},endif:function(){this.endifIndex=null,this.next()},macro:function(){for(var a=this.script.tasks,b=this.taskIndex+1,c=a.length;c>b;++b){var d=a[b];if("endmacro"==d.func){this.set(b);break}}this.next()},endmacro:function(){this["return"]()},l:function(){this.lock(),this.onpointingstart=function(){this.onpointingstart=null,this.unlock(),this.next()}.bind(this)},wait:function(a,b){this.lock(),this.timeline.clear(),this.timeline.call(b.time,function(){this.unlock(),this.next()}.bind(this))},delay:function(a,b){this.chSpeed=b.speed*(a.fps/1e3)|0,this.chSpeed=Math.max(this.chSpeed,1),this.next()},jump:function(a,b){this.jump(b.target)},call:function(a,b){this.call(b.target)},"return":function(){this["return"]()},reload:function(){this.lock(),this.script.reload(),this.script.onload=function(){this.unlock(),this.next()}.bind(this)},event:function(a,b){var c=tm.event.Event("novelevent");c.name=b.name,c.params=b,this.fire(c),this.next()},s:function(){this.finish()}})}(),function(){tm.novel.Tag.set({r:function(){this.labelArea.text+="\n",this.next()},cm:function(){this.labelArea.text="",this.next()},position:function(a,b){var c=this.labelArea;void 0!==b.x&&(c.x=b.x),void 0!==b.y&&(c.y=b.y),void 0!==b.width&&(c.width=b.width),void 0!==b.height&&(c.height=b.height),b.vertical===!0&&(c.mode="vertical"),this.next()},font:function(a,b){var c=this.labelArea;void 0!==b.size&&(c.fontSize=b.size),void 0!==b.color&&(c.fillStyle=b.color),void 0!==b.face&&(c.fontFamily=b.face),void 0!==b.lineSpace&&(c.lineSpace=b.lineSpace),void 0!==b.lineHeight&&(c.lineHeight=b.lineHeight),this.next()}})}(),function(){tm.novel.Tag.set({base:function(a,b){this.basePath=b.path.format(this.variables),this.next()},load:function(a,b){var c=b.path.format(this.variables),d=b.type||c.split(".").last;this.lock();var e=tm.asset.Loader();e.onload=function(){this.unlock(),this.next()}.bind(this);var f={},c=this.basePath?this.basePath+"/"+c:c;console.log(c),f[b.name]={path:c,type:d},e.load(f)}})}(),function(){tm.novel.Tag.set({"new":function(a,b){var c=tm.using(b.type);if(b.arg instanceof Array)var d=c.apply(null,b.arg);else var d=c.call(null,b.arg);this.addNovelElement(b.name,d,b.layer),BASIC_PROPS.each(function(a){var c=b[a];void 0!==c&&(d[a]=c)}),this.next()},set:function(a,b){var c=this.getNovelElement(b.name),d=b.key,e=b.value;d&&(c[d]=e),BASIC_PROPS.each(function(a){var d=b[a];void 0!==d&&(c[a]=d)}),this.next()},exec:function(a,b){var c=this.getNovelElement(b.name);b.arg instanceof Array?c[b.method].apply(c,b.arg):c[b.method].call(c,b.arg),this.next()},"delete":function(a,b){this.removeNovelElement(b.name);this.next()},image_show:function(a,b){var c=tm.display.Sprite(b.name);this.addNovelElement(b.name,c,b.layer),void 0!==b.x&&(c.x=b.x),void 0!==b.y&&(c.y=b.y),void 0!==b.originX&&(c.originX=b.originX),void 0!==b.originY&&(c.originY=b.originY),void 0!==b.width&&(c.width=b.width),void 0!==b.height&&(c.height=b.height),c.show(),c.alpha=0,c.tweener.clear().fadeIn(250).call(function(){}),this.next()},image_hide:function(a,b){var c=this.getNovelElement(b.name);this.lock(),c.tweener.clear().fadeOut(250).call(function(){this.removeNovelElement(b.name),this.unlock(),this.next()}.bind(this))},shape:function(a,b){var c=b.type,d=this.layers[b.layer||1],e=null;switch(c){case"rect":e=tm.display.RectangleShape(b.width,b.height,{strokeStyle:"transparent",fillStyle:b.color});break;default:console.log("そんなタイプないよ!")}d.addImage(b.name,e),e.x=b.x,e.y=b.y,e.alpha=0,e.tweener.clear().fadeIn(250),this.next()},anim:function(a,b){var c=b.time||1e3,d=b.easing,e=this.getNovelElement(b.name),f=e.tweener,g={};BASIC_PROPS.each(function(a){void 0!==b[a]&&(g[a]=b[a])}),f.clear().to(g,c,d),this.next()},anim_by:function(a,b){var c=b.time||1e3,d=b.easing,e=this.getNovelElement(b.name),f=e.tweener,g={};BASIC_PROPS.each(function(a){void 0!==b[a]&&(g[a]=b[a])}),f.clear().by(g,c,d),this.next()}})}(),function(){tm.novel.Tag.set({sound_play:function(a,b){var c=this,d=tm.asset.Manager.get(b.name).clone();b.wait===!0?(this.lock(),d.onended=function(){c.unlock(),c.next()}):this.next(),d.play()},music_play:function(a,b){tm.asset.Manager.get(b.name).setLoop(!0).play(),this.next()},music_stop:function(a,b){tm.asset.Manager.get(b.name).stop()}})}();